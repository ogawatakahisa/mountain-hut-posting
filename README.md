# メール転記マン

## 📌 概要

**メール転記マン** は、Gmail・Google Apps Script・Google Spreadsheet を連携させた、山小屋予約申請メールの**自動転記システム**です。

📩 `wordpress@iodake.jp` から送信される予約メール（こちらはテスト用のため送信もとメールは問いません）を解析し、  
📝 各山荘の予約スプレッドシートに必要な情報を自動で転記します。

---

## ✅ 主な機能

### 1. 自動メール取得

- Gmailの受信トレイから、以下の条件に一致する予約申請メールを取得：
  - 件名：`ご予約依頼を受付いたしました`
  - 送信元：`wordpress@iodake.jp`
  - `Re:` や `FW:` などの返信・転送メールは除外
  - 既に処理済ラベル（Successなど）が付いていないもの

---

### 2. メール本文の解析

予約申請メールから以下の情報を自動抽出：

| 項目 | 抽出内容例 |
|------|------------|
| 氏名 | 山田 太郎 |
| 宿泊日 | 件名の日付から解析 |
| 泊数 | `泊数：2` |
| 人数 | 男・女・中・小・幼に分類 |
| 食事内容 | 朝食・夕食・弁当など |
| 個室希望 | 山荘ごとに定義された表現で処理 |
| 送迎場所・時間 | 迎え/送り時間と送迎場所 |
| 電話番号 | ハイフン付きに整形 |
| 登山口 | `入山口：〇〇` より抽出 |
| 備考欄 | 連絡事項がある場合は検索用文字列を追記 |

---

### 3. スプレッドシートへの転記

- 日付・山荘に対応するブック・シートを自動選択
- `氏名` 列の最初の空行に自動で転記
- シートやブックが未作成の場合はスキップしてラベルで通知

---

### 4. Gmail ラベルによるステータス管理

処理状況に応じて、以下のラベルが Gmail スレッドに付与されます：

| ラベル名 | 条件 / 内容 |
|----------|-------------|
| `Success` | 完全に転記処理が完了した |
| `Success/MailCh` | メール文言の変更により一部項目が取得できなかった |
| `Success/SheetCh` | スプレッドシート側の構造変更で一部項目の転記に失敗 |
| `予約上限` | シートの最大行数に達していたため転記不可 |
| `未作成のブック` | 指定の予約ブックが存在しない |
| `未作成のシート` | 指定日付のシートが存在しない |
| `not氏名in予約表` | 氏名列が存在せず転記不可 |
| `not備考in予約表` | 備考列が存在せず備考の追記ができなかった |
| `イレギュラー日付` | 件名に日付が含まれず処理不可 |
| `テスト範囲外` | 開始日以前など対象外データ |
| `想定外エラー` | その他例外エラーが発生した場合 |
| `想定外エラー/接続エラー` | スプレッドシートへのアクセス失敗時 |

---

## ⚙️ システム構成

- **Google Apps Script (GAS)**
- **Gmail**
- **Google Spreadsheet**

## 📎 関連システム
配車マン（LINE連携で送迎情報を通知）と同一スプレッドシートを利用

